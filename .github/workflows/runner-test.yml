name: Test - Runner
run-name: '${{ github.event.inputs.runner }} - ${{ github.event.inputs.model }}'
on:
  workflow_dispatch:
    inputs:
      runner:
        description: 'Runner'
        required: true
        type: choice
        options:
          - 'h100-cr_0'
          - 'h100-cr_1'
          - 'h100-cw_0'
          - 'h100-cw_1'
          - 'h200-cw_0'
          - 'h200-cw_1'
          - 'h200-nb_0'
          - 'h200-nb_1'
          - 'h200-nb_2'
          - 'h200-nb_3'
          - 'h200-nv_0'
          - 'h200-nv_1'
          - 'h200-nv_2'
          - 'h200-nv_3'
          - 'b200-nv_0'
          - 'b200-nv_1'
          - 'b200-nb_0'
          - 'b200-nb_1'
          - 'b200-nvd_0'
          - 'b200-nvd_1'
          - 'b200-nvd_2'
          - 'b200-nvd_3'
          - 'b200-tg_0'
          - 'mi300x-amd_0'
          - 'mi300x-amd_1'
          - 'mi300x-amd_2'
          - 'mi300x-amd_3'
          - 'mi300x-amd_4'
          - 'mi300x-cr_0'
          - 'mi300x-oci_0'
          - 'mi325x-amd_0'
          - 'mi325x-tw_0'
          - 'mi325x-tw_1'
          - 'mi325x-tw_2'
          - 'mi325x-tw_3'
          - 'mi355x-amd_0'
          - 'mi355x-amd_1'
          - 'mi355x-amd_2'
          - 'mi355x-amd_3'

      image:
        description: 'Docker Image'
        required: true
        type: choice
        options:
          - 'lmsysorg/sglang:v0.4.9.post1-cu126'
          - 'lmsysorg/sglang:v0.5.0rc1-cu128-b200'
          - 'lmsysorg/sglang:v0.5.2rc2-cu126'
          - 'lmsysorg/sglang:v0.5.3rc1-cu129-b200'
          - 'nvcr.io#nvidia/tensorrt-llm/release:1.1.0rc2'
          - 'nvcr.io#nvidia/tensorrt-llm/release:1.1.0rc2.post1'
          - 'nvcr.io#nvidia/tensorrt-llm/release:1.1.0rc2.post2'
          - 'nvcr.io#nvidia/tensorrt-llm/release:1.2.0rc0.post1'
          - 'nvcr.io#nvidia/tensorrt-llm/release:gpt-oss-dev'
          - 'rocm/7.0-preview:rocm7.0_preview_ubuntu_22.04_vllm_0.10.1_instinct_rc1'
          - 'rocm/7.0-preview:rocm7.0_preview_ubuntu_22.04_sgl-dev-v0.5.2rc2-mi30x_rc1'
          - 'rocm/7.0:rocm7.0_ubuntu_22.04_sgl-dev-v0.5.2-rocm7.0-mi30x-20250915'
          - 'rocm/7.0:rocm7.0_ubuntu_22.04_sgl-dev-v0.5.2-rocm7.0-mi35x-20250915'
          - 'rocm/7.0:rocm7.0_ubuntu_22.04_vllm_0.10.1_instinct_20250915'
          - 'rocm/7.0:rocm7.0_ubuntu_22.04_vllm_0.10.1_instinct_20250927_rc1'
          - 'vllm/vllm-openai:v0.10.2'
      model:
        description: 'Model'
        required: true
        type: choice
        options:
          - 'amd/DeepSeek-R1-0528-MXFP4-Preview'
          - 'amd/Llama-3.3-70B-Instruct-FP8-KV'
          - 'amd/Llama-3.3-70B-Instruct-MXFP4-Preview'
          - 'deepseek-ai/DeepSeek-R1-0528'
          - 'nvidia/Llama-3.3-70B-Instruct-FP8'
          - 'nvidia/Llama-3.3-70B-Instruct-FP4'
          - 'nvidia/DeepSeek-R1-0528-FP4'
          - 'nvidia/DeepSeek-R1-0528-FP4-v2'
          - 'openai/gpt-oss-120b'

      framework:
        description: 'Framework'
        required: true
        type: choice
        options:
          - 'vllm'
          - 'sglang'
          - 'trt'

      precision:
        description: 'Precision'
        required: true
        type: choice
        options:
          - 'fp8'
          - 'fp4'

      exp-name:
        description: 'Experiment Name'
        required: true
        type: choice
        options:
          - '70b_test'
          - 'dsr1_test'
          - 'gptoss_test'
        
jobs:
  runner-test:
    uses: ./.github/workflows/benchmark-tmpl.yml
    secrets: inherit
    with:
      runner: ${{ inputs.runner }}
      image: ${{ inputs.image }}
      model: ${{ inputs.model }}
      framework: ${{ inputs.framework }}
      precision: ${{ inputs.precision }}
      exp-name: ${{ inputs.exp-name }}
      isl: 1024
      osl: 1024
      max-model-len: 2048
      random-range-ratio: 0.8
      tp-list: '[1,2,4]'
      conc-list: '[64]'

  collect-test-results:
    needs: runner-test
    uses: ./.github/workflows/collect-results.yml
    secrets: inherit
    with:
      exp-name: ${{ inputs.exp-name }}
